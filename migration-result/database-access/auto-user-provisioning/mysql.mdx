---
title: MySQL Automatic User Provisioning 
description: Configure automatic user provisioning for MySQL.
version: '15.x'
---

<Accordion title="Version warning">
  Automatic user provisioning for MySQL is available starting from Teleport
  14.1.
</Accordion>

## Prerequisites

- Teleport cluster with a configured [self-hosted MySQL](/database-access/guides/mysql-self-hosted)
  or [RDS MySQL](/database-access/guides/rds) database.
- Ability to connect to and create user accounts in the target database.

<Note>
  Automatic user provisioning is not compatible with MySQL versions lower than
  8.0.
</Note>

## Step 1/3. Configure database admin

Teleport should be able to connect to the database as a user that can create
other users and assign them roles. We recommend creating a separate user
designated specifically for Teleport automatic user provisioning. Let's call it
`teleport-admin`.

Teleport uses the same authentication mechanism when connecting as an admin user
as for regular user connections: X.509 for self-hosted databases and AWS IAM
for RDS.

The admin user must have privileges within the database to create users and
grant them privileges. The admin user must also have privileges to monitor user
processes and role assignments.

In addition, a schema is required for the admin user to log into by default.
Stored procedures are also created and executed from this schema.

<Tabs>
  <Tab title="RDS MySQL">
    The RDS MySQL admin user must use `AWSAuthenticationPlugin` to allow IAM
    authentication:

    ```sql
    CREATE USER 'teleport-admin' IDENTIFIED WITH AWSAuthenticationPlugin AS 'RDS';
    GRANT SELECT ON mysql.role_edges TO 'teleport-admin' ;
    GRANT PROCESS, ROLE_ADMIN, CREATE USER ON *.* TO 'teleport-admin' ;

    CREATE DATABASE IF NOT EXISTS `teleport`;
    GRANT ALTER ROUTINE, CREATE ROUTINE, EXECUTE ON `teleport`.* TO 'teleport-admin' ;
    ```
  </Tab>

  <Tab title="Self-hosted MySQL">
    The self-hosted MySQL admin user must have X.509 authentication configured:

    ```sql
    CREATE USER "teleport-admin" REQUIRE SUBJECT "/CN=teleport-admin";
    GRANT SELECT ON mysql.role_edges TO 'teleport-admin' ;
    GRANT PROCESS, ROLE_ADMIN, CREATE USER ON *.* TO 'teleport-admin' ;

    CREATE DATABASE IF NOT EXISTS `teleport`;
    GRANT ALTER ROUTINE, CREATE ROUTINE, EXECUTE ON `teleport`.* TO 'teleport-admin' ;
    ```
  </Tab>
</Tabs>

Users created by Teleport will be assigned the `teleport-auto-user` role in the
database, which will be created automatically if it doesn't exist.

Next, enable the database admin on the Teleport database configuration:

<Tabs>
  <Tab title="Static config">
    ```yaml
    db_service:
      enabled: "yes"
      databases:
      - name: "example"
        protocol: "mysql"
        uri: "localhost:3306"
        admin_user:
          name: "teleport-admin"
    ```
  </Tab>

  <Tab title="Dynamic resource">
    ```yaml
    kind: db
    version: v3
    metadata:
      name: example
    spec:
      protocol: "mysql"
      uri: "localhost:3306"
      admin_user:
        name: "teleport-admin"
    ```
  </Tab>
</Tabs>

<Tip>
  For auto-discovered cloud databases, the name of the admin user is taken from
  the `teleport.dev/db-admin` label.
</Tip>

## Step 2/3. Configure Teleport role

To specify the database roles a user should be assigned within the database,
use the `db_roles` role option:

```yaml
kind: role
version: v7
metadata:
  name: auto-db-users
spec:
  options:
    # create_db_user_mode enables automatic user provisioning for matching databases
    create_db_user_mode: keep
  allow:
    db_labels:
      "*": "*"
    db_names:
    - "*"
    # db_roles is a list of roles the database user will be assigned
    db_roles:
    - reader
    - "{{internal.db_roles}}"
    - "{{external.db_roles}}"
```

With automatic user provisioning, users always connect to the database with
their Teleport username so the `db_users` role field is ignored for roles
that have database user provisioning enabled.

The available provisioning modes are:

- `off`: Disables user provisioning.

- `keep`: Enables user provisioning and disables users at session end. The user
  will be stripped of all roles and the user account will be locked.

- `best_effort_drop`: Enables user provisioning and tries to drop user
  at session end. If the drop fails, fallback to disabling them (same as `keep`
  mode).

Users created within the database will:

- Be assigned the `teleport-auto-user` role.
- Be assigned all roles from the Teleport user's role set that match the database.
  The role names must be valid and exist in the database.

MySQL limits usernames to 32 characters. When the Teleport
username is within this limit, the user created within the database will have
the same name as the Teleport username. When the Teleport username is over the
32 character limit, the user created within the database will have the
name in the format of `tp-<base64-sha1-teleport-username>`.

<Accordion title="Tracking the name mapping">
  The original Teleport username will be saved as user attributes within the
  databases.

  User can find its own attributes in an auto-provisioned database session by:

  ```sql
  SELECT * FROM INFORMATION_SCHEMA.USER_ATTRIBUTES WHERE CONCAT(USER, '@', HOST) = current_user(); 
  ```

  Database admins can search a particular Teleport username by:

  ```sql
  SELECT * FROM INFORMATION_SCHEMA.USER_ATTRIBUTES WHERE ATTRIBUTE->"$.user" = "teleport-user-name";
  ```

  In addition, the "hashed" in-database name will be recorded as `db_user` for
  database queries in the Teleport Audit Logs, when the Teleport username is over
  32 characters.
</Accordion>

Note that in case of a name conflict where a user with the same name already
exists in the database and is not managed by Teleport (i.e. not assigned the
`teleport-auto-user` role), the connection will be aborted.

## Step 3/3. Connect to the database

Now, log into your Teleport cluster and connect to the database:

```code
$ tsh login --proxy=teleport.example.com
$ tsh db connect --db-name <database> example
```

<Note>
  When connecting to a database with user provisioning enabled, the Database
  Service expects your Teleport username will be used as the database username .

  If using a GUI database client like MySQL Workbench, make sure to use your Teleport
  username as the database username. `tsh db connect` will default to your
  Teleport username automatically when connecting to a database with user
  provisioning enabled.
</Note>

## Next steps

- Connect using your [GUI database client](/connect-your-client/gui-clients).
- Learn about [role templating](/access-controls/guides/role-templates#interpolation-rules).
- Read automatic user provisioning [RFD](https://github.com/gravitational/teleport/blob/master/rfd/0113-automatic-database-users.md).

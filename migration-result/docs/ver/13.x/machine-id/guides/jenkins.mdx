---
title: Using Teleport Machine ID with Jenkins
description: Using Teleport Machine ID with Jenkins
version: "13.x"
---

Jenkins is an open source automation server that is frequently used to build
Continuous Integration and Continuous Delivery (CI/CD) pipelines.

In this guide, we will demonstrate how to migrate existing Jenkins pipelines to
utilize Machine ID with minimal changes.

## Prerequisites

You will need the following tools to use Teleport with Jenkins.

<Tabs>
  <Tab title="Teleport Community Edition">
    - A running Teleport cluster. For details on how to set this up, see our
      [Getting Started](/docs/ver/13.x) guide.

    - The `tctl` admin tool and `tsh` client tool version >= 13.4.16.

      ```bash
      $ tctl version
      # Teleport v13.4.16 go1.21

      $ tsh version
      # Teleport v13.4.16 go1.21
      ```

      See [Installation](/docs/ver/13.x/installation) for details.

    To check version information, run the `tctl version` and `tsh version` commands.
    For example:

    ```bash
    $ tctl version
    # Teleport v13.4.16 go1.21
      
    $ tsh version
    # Teleport v13.4.16 go1.21
    ```
  </Tab>

  <Tab title="Teleport Team">
    - A Teleport Team account. If you don't have an account, sign
      up to begin your [free trial](https://goteleport.com/signup/).

    - The Enterprise `tctl` admin tool and `tsh` client tool, version >= 14.3.6.

      You can download these tools from the [Cloud Downloads page](/docs/ver/13.x/choose-an-edition/teleport-cloud/downloads).

    To check version information, run the `tctl version` and `tsh version` commands.
    For example:

    ```bash
    $ tctl version
    # Teleport Enterprise v14.3.6 go1.21
      
    $ tsh version
    # Teleport v14.3.6 go1.21
    ```
  </Tab>

  <Tab title="Teleport Enterprise">
    - A running Teleport Enterprise cluster. For details on how to set this up, see our Enterprise
      [Getting Started](/docs/ver/13.x/choose-an-edition/teleport-enterprise/introduction) guide.

    - The Enterprise `tctl` admin tool and `tsh` client tool version >=
      13.4.16, which you can download by visiting your [Teleport
      account](https://teleport.sh).

      ```bash
      $ tctl version
      # Teleport Enterprise v13.4.16 go1.21

      $ tsh version
      # Teleport v13.4.16 go1.21
      ```
  </Tab>

  <Tab title="Teleport Enterprise Cloud">
    - A Teleport Enterprise Cloud account. If you do not have one, visit the [signup
      page](https://goteleport.com/signup/) to begin a free trial of Teleport Team
      and upgrade to Teleport Enterprise Cloud.

    - The Enterprise `tctl` admin tool and `tsh` client tool version >= 14.3.6.
      You can download these tools from the [Cloud Downloads page](/docs/ver/13.x/choose-an-edition/teleport-cloud/downloads).

      ```bash
      $ tctl version
      # Teleport Enterprise v14.3.6 go1.21

      $ tsh version
      # Teleport v14.3.6 go1.21
      ```
  </Tab>
</Tabs>

- `ssh` OpenSSH tool
- Jenkins
- Make sure you can connect to your Teleport cluster by authenticating with `tsh`
  so you can execute commands with the `tctl` admin tool:
  <Tabs>
    <Tab title="Self-Hosted">
      ```bash
      $ tsh login --proxy=teleport.example.com --user=email@example.com
      $ tctl status
      # Cluster  teleport.example.com
      # Version  13.4.16
      # CA pin   sha256:abdc1245efgh5678abdc1245efgh5678abdc1245efgh5678abdc1245efgh5678
      ```

      You can run subsequent `tctl` commands in this guide on your local machine.

      For full privileges, you can also run `tctl` commands on your Teleport Auth
      Service host.
    </Tab>

    <Tab title="Teleport Cloud">
      ```bash
      $ tsh login --proxy=myinstance.teleport.sh --user=email@example.com
      $ tctl status
      # Cluster  myinstance.teleport.sh
      # Version  14.3.6
      # CA pin   sha256:sha-hash-here
      ```

      You must run subsequent `tctl` commands in this guide on your local machine.
    </Tab>
  </Tabs>

## Architecture

Before we begin, it should be noted that Jenkins is a tool that is notoriously
difficult to secure. Machine ID is one part of securing your infrastructure,
but it alone is not sufficient. Below we will provide some basic guidance which
can help improve the security posture of your Jenkins installation.

### Single-host deployments

The simplest Jenkins deployments have the
controller (process that stores configuration, plugins, UI) and agents (process
that executes tasks) run on the same host. This deployment model is simple to
get started with, however any compromise of the `jenkins` user within a single
pipeline can lead to the compromise of your entire CI/CD infrastructure.

### Multihost deployments

A slightly more complex, but more secure deployment
is running your Jenkins controllers and agents on different hosts and pinning
workloads to specific agents. This is an improvement over the simple deployment
because you can limit the blast radius of the compromise of a single pipeline
to a subset of your CI/CD infrastructure instead of all of your infrastructure.

### Best practices

We strongly encourage the use of the second deployment model whenever possible,
with ephemeral hosts and IAM joining when possible. When using Machine ID with
this model, create and run Machine ID bots per-host and pin particular
pipelines to a worker. This will allow you to give each pipeline the minimal
scope for server access, reduce the blast radius if one pipeline is
compromised, and allow you to remotely audit and lock pipelines if you detect
malicious behavior.

<img src="/assets/jenkins-53101e7caf.png" alt="Jenkins Deployments" width="1358" height="1266" />

## Step 1/2 Configure and start Machine ID

First, determine if you would like to create a new role for Machine ID or use
an existing role. You can run `tctl get roles` to examine your existing roles.

In the example below, create a file called `api-workers.yaml` with the content below
to create a new role called `api-workers` that will allow you to log in to Nodes
with the label `group: api` and Linux user `jenkins`.

```
kind: "role"
version: "v3"
metadata:
  name: "api-workers"
spec:
  allow:
    logins: ["jenkins"]
    node_labels:
      "group": "api"
```

<Tabs>
  <Tab title="Teleport Enterprise Cloud">
    On your client machine, log in to Teleport using `tsh` before using `tctl`.

    ```bash
    $ tctl create -f api-workers.yaml
    $ tctl bots add jenkins --roles=api-workers
    ```
  </Tab>

  <Tab title="Self-Hosted">
    Connect to the Teleport Auth Server and use `tctl` to examine what roles exist on
    your system.

    ```bash
    $ tctl create -f api-workers.yaml
    $ tctl bots add jenkins --roles=api-workers
    ```
  </Tab>
</Tabs>

Machine ID allows you to use Linux Access Control Lists (ACLs) to control
access to certificates on disk. You will use this to limit the access Jenkins
has to the short-lived certificates Machine ID issues.

In the example that follows, you will create a Linux user called `teleport` to
run Machine ID but short-lived certificates will be written to disk as the
Linux user `jenkins`.

```bash
$ sudo adduser \
    --disabled-password \
    --no-create-home \
    --shell=/bin/false \
    --gecos "" \
    teleport
```

Create and initialize the directories you will need using the `tbot init`
command.

```bash
$ sudo tbot init \
    --destination-dir=/opt/machine-id \
    --bot-user=teleport \
    --owner=teleport:teleport \
    --reader-user=jenkins
```

Create the bot data directory and grant permissions to access it to the Linux user (in our example, `teleport`) which `tbot` will run as.

```bash
# Make the bot directory and assign ownership to teleport user
$ sudo mkdir -p /var/lib/teleport/bot
$ sudo chown teleport:teleport /var/lib/teleport/bot
# Allow teleport user to open directory
$ sudo chmod +x /var/lib/teleport /var/lib/teleport/bot
```

Next, you need to start Machine ID in the background of each Jenkins worker.

<Tabs>
  <Tab title="Teleport Cloud">
    First create a configuration file for Machine ID at `/etc/tbot.yaml`.

    ```yaml
    auth_server: "example.teleport.sh:443"
    onboarding:
      join_method: "token"
      token: "00000000000000000000000000000000"
      ca_pins:
      - "sha256:1111111111111111111111111111111111111111111111111111111111111111"
    storage:
      directory: /var/lib/teleport/bot
    destinations:
      - directory: /opt/machine-id
    ```
  </Tab>

  <Tab title="Self-Hosted">
    First create a configuration file for Machine ID at `/etc/tbot.yaml`.

    ```yaml
    auth_server: "auth.example.com:3025"
    onboarding:
      join_method: "token"
      token: "00000000000000000000000000000000"
      ca_pins:
      - "sha256:1111111111111111111111111111111111111111111111111111111111111111"
    storage:
      directory: /var/lib/teleport/bot
    destinations:
      - directory: /opt/machine-id
    ```
  </Tab>
</Tabs>

Next, create a systemd.unit file at `/etc/systemd/system/machine-id.service`.

```systemd
[Unit]
Description=Teleport Machine ID Service
After=network.target

[Service]
Type=simple
User=teleport
Group=teleport
Restart=on-failure
Environment="TELEPORT_ANONYMOUS_TELEMETRY=1"
ExecStart=/usr/local/bin/tbot start -c /etc/tbot.yaml
ExecReload=/bin/kill -HUP $MAINPID
PIDFile=/run/machine-id.pid
LimitNOFILE=524288

[Install]
WantedBy=multi-user.target
```

`TELEPORT_ANONYMOUS_TELEMETRY` enables the submission of anonymous usage
telemetry. This helps us shape the future development of `tbot`. You can disable
this by omitting this.

Finally, run the following commands to start Machine ID.

```bash
$ sudo systemctl enable machine-id
$ sudo systemctl start machine-id
$ sudo systemctl status machine-id
```

## Step 2/2. Update and run Jenkins pipelines

Using Machine ID within a Jenkins pipeline is now a one-line change. For
example, if you want to run the `hostname` command on a remote host, add the
following to your Jenkins pipeline.

```
steps {
  sh "ssh -F /opt/machine-id/ssh_config root@node-name.example.com hostname"
}
```

You are all set. You have provided Jenkins with short-lived certificates tied
to a machine identity that can be rotated, audited, and controlled with all the
familiar Teleport access controls.

## Next steps

[More information about `TELEPORT_ANONYMOUS_TELEMETRY`.](/docs/ver/13.x/machine-id/reference/telemetry)

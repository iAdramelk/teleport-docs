---
title: Using Teleport Machine ID with Ansible
description: Using Teleport Machine ID with Ansible
version: '13.x'
---

In this guide, you will set up an Ansible playbook to run the OpenSSH client
with a configuration file that is automatically managed by Machine ID.

## Prerequisites

You will need the following tools to use Teleport with Ansible.

<Tabs>
  <Tab title="Open Source">
    - A running Teleport cluster. For details on how to set this up, see our
      [Getting Started](/docs/ver/13.x/index) guide.

    - The `tctl` admin tool and `tsh` client tool version >= 13.2.0.

      ```code
      $ tctl version
      # Teleport v13.2.0 go1.20

      $ tsh version
      # Teleport v13.2.0 go1.20
      ```

      See [Installation](/docs/ver/13.x/installation) for details.
  </Tab>

  <Tab title="Enterprise">
    - A running Teleport Enterprise cluster. For details on how to set this up, see our Enterprise
      [Getting Started](/docs/ver/13.x/choose-an-edition/teleport-enterprise/introduction) guide.

    - The Enterprise `tctl` admin tool and `tsh` client tool version >= 13.2.0,
      which you can download by visiting your [Teleport account](https://teleport.sh).

      ```code
      $ tctl version
      # Teleport Enterprise v13.2.0 go1.20

      $ tsh version
      # Teleport v13.2.0 go1.20
      ```
  </Tab>

  <Tab title="Teleport Cloud">
    - A Teleport Enterprise Cloud account. If you do not have one, visit the [signup
      page](https://goteleport.com/signup/) to begin a free trial of Teleport Team
      and upgrade to Teleport Enterprise Cloud.

    - The Enterprise `tctl` admin tool and `tsh` client tool version >= 13.2.0.
      To download these tools, visit the [Downloads](/docs/ver/13.x/choose-an-edition/teleport-cloud/downloads) page.

      ```code
      $ tctl version
      # Teleport Enterprise v13.2.0 go1.20

      $ tsh version
      # Teleport v13.2.0 go1.20
      ```
  </Tab>
</Tabs>

- `ssh` OpenSSH tool

- `ansible` >= 2.9.6

- Optional: [`jq`](https://stedolan.github.io/jq/) to process `JSON` output

- If you already have not done so, follow the
  [Machine ID Getting Started Guide](/docs/ver/13.x/machine-id/getting-started) to create a bot
  user and start Machine ID.

- If you followed the above guide, note the `--destination-dir=/opt/machine-id`
  flag, which defines the directory where SSH certificates and OpenSSH configuration
  used by Ansible will be written.

  In particular, you will be using the `/opt/machine-id/ssh_config` file in your
  Ansible configuration to define how Ansible should connect to Teleport Nodes.

- Make sure you can connect to Teleport. Log in to your cluster using `tsh`, then use `tctl`
  remotely:
  ```code
  $ tsh login --proxy=teleport.example.com --user=email@example.com
  $ tctl status
  # Cluster  teleport.example.com
  # Version  13.2.0
  # CA pin   sha256:abdc1245efgh5678abdc1245efgh5678abdc1245efgh5678abdc1245efgh5678
  ```
  You can run subsequent `tctl` commands in this guide on your local machine.

  For full privileges, you can also run `tctl` commands on your Auth Service host.
  ```code
  $ tsh login --proxy=myinstance.teleport.sh --user=email@example.com
  $ tctl status
  # Cluster  myinstance.teleport.sh
  # Version  13.2.0
  # CA pin   sha256:sha-hash-here
  ```
  You must run subsequent `tctl` commands in this guide on your local machine.

## Step 1/2. Configure Ansible

Create a folder named `ansible` where all Ansible files will be collected.

```code
$ mkdir -p ansible
$ cd ansible
```

Create a file called `ansible.cfg`. We will configure Ansible
to run the OpenSSH client with the configuration file generated
by Machine ID, `/opt/machine-id/ssh_config`.

```
[defaults]
host_key_checking = True
inventory=./hosts
remote_tmp=/tmp

[ssh_connection]
scp_if_ssh = True
ssh_args = -F /opt/machine-id/ssh_config
```

You can create an inventory file called `hosts` manually or use a script like the one
below to generate it from your environment. Note, `example.com` here is the
name of your Teleport cluster.

```code
$ # Replace ".example.com" below with the name of your cluster.
$ tsh ls --format=json | jq -r '.[].spec.hostname + ".example.com"' > hosts
```

<Accordion title="Not seeing Nodes?">
  When Teleport's Auth Service receives a request to list Teleport Nodes (e.g., to
  display Nodes in the Web UI or via `tsh ls`), it only returns the Nodes that the
  current user is authorized to view.

  For each Node in the user's Teleport cluster, the Auth Service applies the
  following checks in order and, if one check fails, hides the Node from the user:

  - None of the user's roles contain a `deny` rule that matches the Node's labels.
  - At least one of the user's roles contains an `allow` rule that matches the
    Node's labels.

  If you are not seeing Nodes when expected, make sure that your user's roles
  include the appropriate `allow` and `deny` rules as documented in the
  [Teleport Access Controls Reference](/docs/ver/13.x/access-controls/reference).
</Accordion>

## Step 2/2. Run a playbook

Finally, let's create a simple Ansible playbook, `playbook.yaml`.

The playbook below runs `hostname` on all hosts. Make sure to set the
`remote_user` parameter to a valid SSH username that works with the target host
and is allowed by Teleport RBAC. If you followed the [Machine ID getting started
guide](/docs/ver/13.x/machine-id/getting-started), this user will be `root`. Assign ROOT to the username.

```var
- hosts: all
  remote_user: root
  tasks:
    - name: "hostname"
      command: "hostname"
```

From the folder `ansible`, run the Ansible playbook:

```code
$ ansible-playbook playbook.yaml

# PLAY [all] *****************************************************************************************************************************************
# TASK [Gathering Facts] *****************************************************************************************************************************
#
# ok: [terminal]
#
# TASK [hostname] ************************************************************************************************************************************
# changed: [terminal]
#
# PLAY RECAP *****************************************************************************************************************************************
# terminal                   : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

You are all set. You have provided your machine with short-lived certificates
tied to a machine identity that can be rotated, audited, and controlled with
all the familiar Teleport access controls.

## Troubleshooting

In case if Ansible cannot connect, you may see error like this one:

```txt
example.host | UNREACHABLE! => {
    "changed": false,
    "msg": "Failed to connect to the host via ssh: ssh: Could not resolve hostname node-name: Name or service not known",
    "unreachable": true
}
```

You can examine and tweak patterns matching the inventory hosts in `ssh_config`.

Try the SSH connection using `ssh_config` with verbose mode to inspect the error:

```code
$ ssh -vvv -F /opt/machine-id/ssh_config root@node-name.example.com
```

If `ssh` works, try running the playbook with verbose mode on:

```code
$ ansible-playbook -vvv playbook.yaml
```
